<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>PTE Speaking Score Demo</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 40px;
      }
      textarea {
        width: 100%;
        height: 80px;
      }
      button {
        margin-top: 10px;
      }
      #result {
        margin-top: 20px;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h2>PTE Speaking Score Demo</h2>
    <label for="referenceText">Reference Text:</label><br />
    <textarea
      id="referenceText"
      placeholder="Enter reference text..."
    ></textarea
    ><br />

    <button id="recordBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>
    <br />
    <audio
      id="audioPlayback"
      controls
      style="margin-top: 10px; display: none"
    ></audio>
    <br />
    <button id="sendBtn" disabled>Send to API</button>

    <div id="result"></div>

    <script>
      let mediaRecorder;
      let audioChunks = [];
      let audioBlob;

      const recordBtn = document.getElementById("recordBtn");
      const stopBtn = document.getElementById("stopBtn");
      const sendBtn = document.getElementById("sendBtn");
      const audioPlayback = document.getElementById("audioPlayback");
      const resultDiv = document.getElementById("result");

      recordBtn.onclick = async () => {
        audioChunks = [];
        resultDiv.textContent = "";
        sendBtn.disabled = true;
        audioPlayback.style.display = "none";
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        recordBtn.disabled = true;
        stopBtn.disabled = false;
        mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          audioBlob = new Blob(audioChunks, { type: "audio/mp3" });
          audioPlayback.src = URL.createObjectURL(audioBlob);
          audioPlayback.style.display = "block";
          sendBtn.disabled = false;
        };
      };

      stopBtn.onclick = () => {
        mediaRecorder.stop();
        recordBtn.disabled = false;
        stopBtn.disabled = true;
      };

      sendBtn.onclick = async () => {
        const referenceText = document.getElementById("referenceText").value;
        if (!referenceText || !audioBlob) {
          resultDiv.textContent =
            "Please provide reference text and record audio.";
          return;
        }
        resultDiv.textContent = "Sending...";
        const formData = new FormData();
        // Use .mp3 extension for compatibility
        formData.append("audio_file", audioBlob, "recording.mp3");
        formData.append("reference_text", referenceText);
        try {
          const response = await fetch(
            "http://127.0.0.1:8000/speaking/read-aloud",
            {
              method: "POST",
              body: formData,
            }
          );
          const data = await response.json();
          resultDiv.innerHTML = renderResult(data);
        } catch (err) {
          resultDiv.textContent = "Error: " + err;
        }
      };

      // Render result function
      function renderResult(data) {
        if (!data || data.status === 400 || data.status === 500) {
          return `<div style='color:red;'>${data.message || "Error"}</div>`;
        }
        let html = `<h3>Score Summary</h3>`;
        html += `<b>Task Type:</b> ${data.task_type || ""}<br>`;
        html += `<b>Reference Text:</b> ${data.reference_text || ""}<br>`;
        html += `<b>Spoken Text:</b> ${data.spoken_text || ""}<br>`;
        html += `<b>Item Score:</b> <span style='color:green;'>${
          data.item_score || ""
        }</span><br>`;
        html += `<b>Overall Remarks:</b> ${data.overall_remarks || ""}<br>`;
        html += `<h4>Score Distribution</h4>`;
        html += `<table border='1' cellpadding='5' style='border-collapse:collapse;'>`;
        html += `<tr><th>Aspect</th><th>Score</th><th>Remark</th></tr>`;
        for (const key of ["content", "pronunciation", "fluency"]) {
          if (data.score_distribution && data.score_distribution[key]) {
            html += `<tr><td>${
              key.charAt(0).toUpperCase() + key.slice(1)
            }</td><td>${data.score_distribution[key].score}</td><td>${
              data.score_distribution[key].remark
            }</td></tr>`;
          }
        }
        html += `</table>`;
        if (data.alignment_feedback && Array.isArray(data.alignment_feedback)) {
          html += `<h4>Alignment Feedback</h4>`;
          html += `<div style='display:flex;gap:20px;'>`;
          html += `<div><b>Spoken:</b><br>`;
          for (const item of data.alignment_feedback) {
            let color = "#eee";
            if (item.type === "correct") color = "#d4edda"; // green
            else if (item.type === "missing") color = "#f8d7da"; // red
            else if (item.type === "extra") color = "#ffe5b4"; // orange
            else if (item.type === "replace") color = "#cce5ff"; // blue
            html += `<span style='background:${color};padding:2px 6px;margin:2px;border-radius:4px;display:inline-block;'>${
              (item.spoken || []).join(" ") || "&nbsp;"
            }</span>`;
          }
          html += `</div>`;
          html += `<div><b>Reference:</b><br>`;
          for (const item of data.alignment_feedback) {
            let color = "#eee";
            if (item.type === "correct") color = "#d4edda"; // green
            else if (item.type === "missing") color = "#f8d7da"; // red
            else if (item.type === "extra") color = "#ffe5b4"; // orange
            else if (item.type === "replace") color = "#cce5ff"; // blue
            html += `<span style='background:${color};padding:2px 6px;margin:2px;border-radius:4px;display:inline-block;'>${
              (item.ref || []).join(" ") || "&nbsp;"
            }</span>`;
          }
          html += `</div>`;
          html += `</div>`;
          html += `<div style='margin-top:10px;font-size:0.95em;'>`;
          html += `<span style='background:#d4edda;padding:2px 6px;border-radius:4px;'>Correct</span> `;
          html += `<span style='background:#f8d7da;padding:2px 6px;border-radius:4px;'>Missing</span> `;
          html += `<span style='background:#ffe5b4;padding:2px 6px;border-radius:4px;'>Extra</span> `;
          html += `<span style='background:#cce5ff;padding:2px 6px;border-radius:4px;'>Replace</span>`;
          html += `</div>`;
        }
        if (data.note) {
          html += `<br><b>Note:</b> ${data.note}`;
        }
        return html;
      }
    </script>
  </body>
</html>
